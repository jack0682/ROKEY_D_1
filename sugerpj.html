<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sugar Water Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f0f4f7;
      font-family: 'Arial', sans-serif;
      text-align: center;
      font-size: 16px;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      padding: 20px 0;
    }

    h1 {
      color: #2c3e50;
      font-size: 1.8rem;
      margin-bottom: 16px;
    }

    .cup-container {
      position: relative;
      width: 220px;
      height: 300px;
      margin: 0 auto 20px;
      border-radius: 0 0 80px 80px;
      background: linear-gradient(to bottom, #e0f7ff 0%, #ffffff 40%, #d6eaff 100%);
      box-shadow:
        inset 0 5px 8px rgba(255, 255, 255, 0.5),
        inset 0 -8px 12px rgba(0, 0, 0, 0.1),
        0 5px 10px rgba(0, 0, 0, 0.15);
      border: 3px solid #b0d4f1;
      backdrop-filter: blur(1px);
      overflow: hidden;
    }

    .water {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, #4da9f3, #a0dfff);
      transition: height 0.5s ease;
      border-top: 1px solid #fff;
    }

    .cup-status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      font-size: 1.2rem;
      font-weight: bold;
      color: #2c3e50;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 6px 12px;
      border-radius: 12px;
      pointer-events: none;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      white-space: nowrap;
    }

    .weight-display {
      font-size: 1.4em;
      color: #34495e;
      margin-bottom: 6px;
    }

    .sugar-display,
    .concentration-display {
      font-size: 1.2em;
      margin-bottom: 6px;
    }

    .sugar-display { color: #16a085; }
    .concentration-display { color: #8e44ad; }

    .control-panel {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
      margin-bottom: 16px;
    }

    .control-panel > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 220px;
      width: 100%;
    }

    .control-panel button {
      width: 100%;
      padding: 10px 12px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .control-panel .left button {
      background-color: #f39c12;
      color: white;
    }

    .control-panel .right {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .control-panel .right button {
      width: auto;
      min-width: 90px;
    }

    #start-button {
      background-color: #27ae60;
      color: white;
    }

    #stop-button {
      background-color: #e74c3c;
      color: white;
      display: none;
    }

    #concentration-input-box {
      display: none;
      margin-top: 8px;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    #concentration-input-box input {
      padding: 8px;
      font-size: 0.9rem;
      width: 70px;
      text-align: center;
    }

    #concentration-input-box button {
      padding: 8px 10px;
    }

    .concentration-set {
      margin-top: 8px;
      font-size: 1rem;
      color: #2c3e50;
      text-align: center;
    }

    @media (max-width: 500px) {
      .control-panel {
        flex-direction: column;
        align-items: center;
      }

      .control-panel > div {
        width: 100%;
        max-width: 220px;
      }

      #concentration-input-box {
        flex-direction: column;
      }

      .control-panel .right {
        flex-direction: column;
      }

      .control-panel .right button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<h1>Sugar Water Experiment</h1>

<div class="cup-container">
  <div class="water" id="water"></div>
  <div class="cup-status" id="cup-status">💤 대기중...</div>
</div>

<div class="weight-display"><span id="weight-value">0</span> g / 250 g</div>
<div class="sugar-display" id="sugar-value">설탕 무게: - g</div>
<div class="concentration-display" id="concentration-value">농도: - %</div>

<div class="control-panel">
  <div class="left">
    <button onclick="toggleInputBox()">농도 선택</button>
    <div id="concentration-input-box">
      <input type="number" id="concentration-input" min="0" max="100" placeholder="% 입력" />
      <button onclick="setConcentration()">입력</button>
    </div>
    <div class="concentration-set" id="selected-concentration">농도 설정값: -</div>
  </div>
  <div class="right">
    <button id="start-button" onclick="startExperiment()">▶ 시작</button>
    <button id="stop-button" onclick="stopExperiment()">⏹ 중지</button>
  </div>
</div>

<script>
  const MAX_WEIGHT = 250;
  let isSugarNext = false;
  let sugarWeight = null;
  let totalWeight = null;
  let currentPhase = 0;
  let customConcentration = null;

  function setStatusText() {
    const cupStatus = document.getElementById("cup-status");
    switch (currentPhase) {
      case 0: cupStatus.innerText = "💤 대기중..."; break;
      case 1: cupStatus.innerText = "🍬 설탕 투입 중..."; break;
      case 1.5: cupStatus.innerText = "🍬 설탕 투입 완료"; break;
      case 2: cupStatus.innerText = "💧 물 붓는 중..."; break;
      case 3: cupStatus.innerText = "✅ 완료"; break;
      case 99: cupStatus.innerText = "🚀 실행 중..."; break;
    }
  }

  function updateCup(data) {
    const weight = Math.min(data.weight, MAX_WEIGHT);
if (weight <= 0) return;
    const percent = (weight / MAX_WEIGHT) * 100;
    document.getElementById("water").style.height = percent + "%";
    document.getElementById("weight-value").innerText = weight;

    if (isSugarNext) {
      sugarWeight = 1.5;
      isSugarNext = false;
      currentPhase = 1.5;
      setStatusText();
      document.getElementById("sugar-value").innerText = `설탕 무게:  1.5g`;
      document.getElementById("concentration-value").innerText = `농도: - %`;
    } else {
      totalWeight = weight;
      if (sugarWeight !== null && totalWeight > 0) {
        const concentration = ((sugarWeight / totalWeight) * 100).toFixed(2);
        document.getElementById("concentration-value").innerText = `농도: ${concentration} %`;
      }
    }
  }

  function toggleInputBox() {
    const box = document.getElementById("concentration-input-box");
    box.style.display = box.style.display === "none" ? "flex" : "none";
  }

function setConcentration() {
  const value = parseFloat(document.getElementById("concentration-input").value);
  if (!isNaN(value) && value >= 0.75 && value <= 2.5) {
    customConcentration = value;
    document.getElementById("selected-concentration").innerText = `농도 설정값: ${customConcentration} %`;
    document.getElementById("concentration-input-box").style.display = "none";
  } else {
    alert("농도는 0.75% 이상 2.5% 이하로 입력해주세요.");
  }
}

function startExperiment() {
  currentPhase = 99;
  setStatusText();
  document.getElementById("start-button").innerText = "⏳ 실행 중...";
  document.getElementById("start-button").style.backgroundColor = "#95a5a6";
  document.getElementById("stop-button").style.display = "inline-block";

  // 농도 설정값 퍼블리시
  if (customConcentration !== null) {
    client.publish("test", JSON.stringify({ concentration: 1.5/customConcentration*100 }));
  } else {
    alert("농도 설정값이 없습니다. 먼저 농도를 입력해주세요.");
  }
}

function stopExperiment() {
  currentPhase = 0;
  setStatusText();
  document.getElementById("start-button").innerText = "▶ 시작";
  document.getElementById("start-button").style.backgroundColor = "#27ae60";
  document.getElementById("stop-button").style.display = "none";
  sugarWeight = null;
  totalWeight = null;
  document.getElementById("sugar-value").innerText = "설탕 무게: - g";
  document.getElementById("concentration-value").innerText = "농도: - %";
  document.getElementById("water").style.height = "0%";
  document.getElementById("weight-value").innerText = "0";

  // ✅ 중지 메시지 퍼블리시
  client.publish("test", JSON.stringify({ stop: 1 }));
}

  const client = mqtt.connect("wss://p021f2cb.ala.asia-southeast1.emqxsl.com:8084/mqtt", {
    username: "Rokey",
    password: "1234567",
    keepalive: 60,
    connectTimeout: 4000
  });

  client.on("connect", () => {
    client.subscribe("test");
  });

  client.on("message", (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      if (data.event === "1") { isSugarNext = true; currentPhase = 1; setStatusText(); return; }
      if (data.event === "2") { currentPhase = 2; setStatusText(); return; }
      if (data.event === "3") { currentPhase = 3; setStatusText(); return; }
      if (data.sensor_type === "scale" && (isSugarNext || sugarWeight !== null)) {
        updateCup(data);
      }
    } catch (err) { /* 무시 */ }
  });

  setStatusText();
</script>
</body>
</html>
