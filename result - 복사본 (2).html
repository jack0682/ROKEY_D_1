<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>SafetyGuard Controller - Multi-Robot</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        #loading-spinner {
            width: 24px;
            height: 24px;
            display: none;
            margin-right: 5px;
          }
            body {
              font-family: sans-serif;
              text-align: center;
              padding-top: 30px;
              background-color: #f2f2f2;
            }
            button {
              font-size: 20px;
              padding: 15px 30px;
              margin: 10px;
              cursor: pointer;
              border: none;
              color: white;
              border-radius: 5px;
              transition: all 0.3s;
            }
            .start-button {
              background-color: #007bff;
            }
            .start-button:hover {
              background-color: #0069d9;
            }
            .stop-button {
              background-color: #dc3545;
            }
            .stop-button:hover {
              background-color: #c82333;
            }
            #log {
              margin: 20px auto;
              width: 80%;
              max-height: 300px;
              overflow-y: auto;
              border: 1px solid #ccc;
              padding: 10px;
              text-align: left;
              background-color: #fff;
              box-shadow: 0 0 5px rgba(0,0,0,0.1);
              white-space: pre-wrap;
              border-radius: 5px;
            }
            .log-entry {
              margin-bottom: 5px;
              font-size: 16px;
              padding: 5px;
              border-bottom: 1px solid #eee;
            }
            #status {
              margin: 20px auto;
              font-size: 18px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              color: #333;
            }
            .robot-status {
              margin: 10px;
              padding: 10px;
              border-radius: 5px;
              background-color: #fff;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            #status-icon {
              width: 30px;
              height: 30px;
              display: none;
            }
          #map-container {
            margin: 20px auto;
            width: 480px;
            height: 400px;
            border: 2px solid #333;
            position: relative;
            background-image: url('https://drive.google.com/thumbnail?id=16mRaifegpjMcveECSq1nhSydL7A85JPn&sz=w1000');
            background-size: contain;
            background-position: center;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: rotate(180deg);
            transform-origin: center;
          }

          .location-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%) rotate(180deg);
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: all 0.3s;
          }

            .location-marker:hover {
              transform: translate(-50%, -50%) scale(1.3);
              z-index: 10;
            }
           .marker-label {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            transform: translateX(-50%) rotate(180deg);
            bottom: -25px;
          }
            .alert-pulse {
              animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
              0% { transform: translate(-50%, -50%) scale(1); }
              50% { transform: translate(-50%, -50%) scale(1.2); }
              100% { transform: translate(-50%, -50%) scale(1); }
            }
            h2 {
              color: #333;
              margin-bottom: 20px;
              text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            }
            .button-group {
              display: flex;
              justify-content: center;
              flex-wrap: wrap;
            }
            .robot-control {
              margin: 10px;
              padding: 15px;
              border-radius: 8px;
              background-color: #e9ecef;
            }
    </style>
</head>
<body>
<h2>SafetyGuard Controller - Multi-Robot</h2>

<div class="button-group">
    <div class="robot-control">
        <h3>A구역 로봇</h3>
        <button class="start-button" onclick="confirmAndSend('1', 'A구역 시작', 'A')">안전탐지 시작</button>
        <button class="stop-button" onclick="confirmAndSend('2', 'A구역 중지', 'A')">중지</button>
        <div class="robot-status" id="status-A">
            <img class="loading-spinner" src="https://i.gifer.com/origin/b4/b4d657e7ef262b88eb5f7ac021edda87.gif" alt="로딩중" style="display:none; width:24px; height:24px;"/>
            <span class="status-text">현재 상태 : 정지</span>
        </div>
    </div>

    <div class="robot-control">
        <h3>B구역 로봇</h3>
        <button class="start-button" onclick="confirmAndSend('1', 'B구역 시작', 'B')">안전탐지 시작</button>
        <button class="stop-button" onclick="confirmAndSend('2', 'B구역 중지', 'B')">중지</button>
        <div class="robot-status" id="status-B">
            <img class="loading-spinner" src="https://i.gifer.com/origin/b4/b4d657e7ef262b88eb5f7ac021edda87.gif" alt="로딩중" style="display:none; width:24px; height:24px;"/>
            <span class="status-text">현재 상태 : 정지</span>
        </div>
    </div>
</div>

<div id="map-container"></div>

<div id="log"><strong>📡 탐지결과:</strong><br></div>
<button onclick="clearLog()" style="margin-top: 10px; background-color: #6c757d;" class="stop-button">🧹 로그 초기화</button>
<script>
    const options = {
      clean: true,
      connectTimeout: 4000,
      clientId: 'mqtt-html-client-' + Math.floor(Math.random() * 1000),
      username: 'Rokey',
      password: '1234567',
    };

    const topic = 'detect';
    const client = mqtt.connect('wss://p021f2cb.ala.asia-southeast1.emqxsl.com:8084/mqtt', options);
    const recentTypes = {};
    const MIN_INTERVAL = 5000;

    const mapContainer = document.getElementById('map-container');

    function updateStatus(isRunning, zone) {
        const statusElement = document.getElementById(`status-${zone}`);
        const loadingSpinner = statusElement.querySelector('.loading-spinner');
        const statusText = statusElement.querySelector('.status-text');

        if (isRunning) {
            statusText.textContent = '현재 상태 : 가동중';
            statusText.style.color = '#28a745';
            loadingSpinner.style.display = 'inline-block';
        } else {
            statusText.textContent = '현재 상태 : 정지';
            statusText.style.color = '#dc3545';
            loadingSpinner.style.display = 'none';
        }
    }

    // 초기 상태 설정
    updateStatus(false, 'A');
    updateStatus(false, 'B');

    client.on('connect', function () {
      console.log('✅ MQTT 연결됨!');
      client.subscribe(topic, function (err) {
        if (err) {
          console.error('❌ 구독 실패:', err);
        } else {
          console.log(`📡 구독됨: ${topic}`);
        }
      });
    });

    client.on('message', function (topic, message) {
    const logDiv = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    let msg = message.toString();
    let logText = '';
    let emoji = '';

    try {
        const json = JSON.parse(msg);

        // Handle 'tf' type messages (robot position updates)
        if (json.type === 'tf') {
            if (json.location && Array.isArray(json.location)) {
                // Create a blue marker for robot position
                createLocationMarker(json.location, 'robot-position', '로봇 위치', 'rgba(0, 0, 255, 0.7)');
                console.log(`🤖 로봇 위치 업데이트: [${json.location.join(', ')}]`);
            }
            return; // Skip further processing for tf messages
        }

        // type이 없거나 허용된 타입이 아닌 경우 무시
        if (!json.type || 
            !['crack1', 'crack3', 'human1', 'human3'].includes(json.type)) {
            return;
        }

        const now = Date.now();
        if (recentTypes[json.type] && now - recentTypes[json.type] < MIN_INTERVAL) {
            console.log(`⏱️ '${json.type}' 최근 ${MIN_INTERVAL / 1000}s 이내 수신됨 → 건너뜀`);
            return;
        }
        recentTypes[json.type] = now;

        // 기존 switch 문 유지
        let area = '';
        let messageStr = '';
        let markerColor = 'red';

        switch (json.type) {
            case 'human1':
                area = 'A구역';
                messageStr = '안전수칙 미준수자 발견';
                emoji = '🕵️‍♂️';
                markerColor = 'rgba(255, 0, 0, 0.7)';
                break;
            case 'human3':
                area = 'B구역';
                messageStr = '안전수칙 미준수자 발견';
                emoji = '🕵️‍♂️';
                markerColor = 'rgba(255, 0, 0, 0.7)';
                break;
            case 'crack1':
                area = 'A구역';
                messageStr = '크랙 발견';
                emoji = '⚠️';
                markerColor = 'rgba(255, 165, 0, 0.7)';
                break;
            case 'crack3':
                area = 'B구역';
                messageStr = '크랙 발견';
                emoji = '⚠️';
                markerColor = 'rgba(255, 165, 0, 0.7)';
                break;
        }

        let locationStr = '';
        if (json.location && Array.isArray(json.location)) {
            locationStr = `[${json.location.join(', ')}]`;
            createLocationMarker(json.location, json.type, area, markerColor);
        } else {
            locationStr = '위치 정보 없음';
        }

        logText = `${emoji} [${time}] 🏷️ ${area} - 위치: ${locationStr} | ${messageStr}`;
        logDiv.innerHTML += `<div class="log-entry">${logText}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;

    } catch (e) {
        console.error('메시지 파싱 오류:', e);
    }
});

    // 위치 마커 생성 함수
    function createLocationMarker(location, type, area, color) {
        // 기존 마커 제거
        const existingMarkers = document.querySelectorAll('.location-marker');
        existingMarkers.forEach(marker => marker.remove());

        // 좌표 변환 실행 (180도 회전 적용)
        const coord = convertCoordinates(location[0], location[1]);

        // 마커 생성
        const marker = document.createElement('div');
        marker.className = 'location-marker alert-pulse';
        marker.style.left = `${coord.x}px`;
        marker.style.top = `${coord.y}px`;
        marker.style.backgroundColor = color;

        // 라벨 추가 (실제 좌표 표시)
        const label = document.createElement('div');
        label.className = 'marker-label';
        label.textContent = `${area} (${coord.originalX.toFixed(1)}, ${coord.originalY.toFixed(1)})`;
        marker.appendChild(label);

        mapContainer.appendChild(marker);
    }

    client.on('error', function (err) {
        console.error('❌ 연결 실패:', err);
    });

    function confirmAndSend(commandValue, actionName, zone) {
    const confirmed = confirm(`${actionName}하시겠습니까?`);
    if (!confirmed) return;

    let messageObj;
    let sendTopic = topic; // 기본 detect 토픽

    if (zone === 'B') {
        // B구역은 'controll' 필드 사용 (주의: 오타 없는지 확인하세요)
        messageObj = {
	   type: 'controll',
            command: commandValue === '1' ? 'start' : 'stop'
        };
        
    } else {
        // A구역은 기존 command 형식 유지
        messageObj = {
            command: commandValue,
            zone: zone
        };
    }

    const message = JSON.stringify(messageObj);
    client.publish(sendTopic, message);
    console.log(`📤 ${zone}구역으로 전송됨 → ${message}`);

    if (commandValue === '1') {
        updateStatus(true, zone);
    } else if (commandValue === '2') {
        updateStatus(false, zone);
    }
}
    function convertCoordinates(originalX, originalY) {
        const containerWidth = 480;
        const containerHeight = 400;

        // X 좌표 변환 (-7 → 0px, 0 → 480px)
        const pixelX = ((originalX + 7) / 7) * containerWidth;

        // Y 좌표 변환 (-3.5 → 400px, 2 → 0px)
        const pixelY = ((2 - originalY) / 5.5) * containerHeight;

        return {
            x: Math.max(0, Math.min(containerWidth, pixelX)),
            y: Math.max(0, Math.min(containerHeight, pixelY)),
            originalX: originalX,
            originalY: originalY
        };
    }

    // 위치 마커 생성 함수 (수정 버전)
    function createLocationMarker(location, type, area, color) {
        const coord = convertCoordinates(location[0], location[1]);

        // 고유 ID 생성 (같은 위치에 중복 생성 방지)
        const markerId = `marker-${type}-${Date.now()}`;

        const marker = document.createElement('div');
        marker.id = markerId;
        marker.className = 'location-marker alert-pulse';
        marker.style.left = `${coord.x}px`;
        marker.style.top = `${coord.y}px`;
        marker.style.backgroundColor = color;

        // 라벨 추가
        const label = document.createElement('div');
        label.className = 'marker-label';
        label.textContent = `${area} (${coord.originalX.toFixed(1)}, ${coord.originalY.toFixed(1)})`;
        marker.appendChild(label);

        // 마커에 삭제 버튼 추가
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'marker-delete-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = function() {
            document.getElementById(markerId).remove();
        };
        marker.appendChild(deleteBtn);

        mapContainer.appendChild(marker);

        console.log(`새 마커 추가: ${markerId}`);
    }
function clearLog() {
    const logDiv = document.getElementById('log');
    logDiv.innerHTML = '<strong>📡 탐지결과:</strong><br>';
    console.log("🧹 로그 초기화됨");
}
    const style = document.createElement('style');
    style.textContent = `
        .marker-delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: red;
            border-radius: 50%;
            color: white;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: pointer;
            z-index: 20;
        }
        .marker-delete-btn:hover {
            background: darkred;
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>